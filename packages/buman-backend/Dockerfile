# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build buman-backend`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t buman-backend`.
FROM docker.io/node:lts-alpine as build-stage

ARG HOST_BUMAN_BACKEND
ARG PORT_BUMAN_BACKEND
ENV HOST_BUMAN_BACKEND=${HOST_BUMAN_BACKEND}
ENV PORT_BUMAN_BACKEND=${PORT_BUMAN_BACKEND}

WORKDIR /app

COPY package.json ./buman-backend/

RUN npm i -g pnpm && \
  pnpm install --prefix buman-backend/ --only=prod

FROM docker.io/node:lts-alpine as runtime-stage

WORKDIR /app

COPY dist/packages/buman-backend buman-backend
COPY --from=build-stage /app/buman-backend/package.json buman-backend/
COPY --from=build-stage /app/buman-backend/node_modules ./buman-backend/node_modules/

CMD [ "node", "buman-backend/main.js" ]

